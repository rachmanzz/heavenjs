!function(e,t){"undefined"!=typeof e?t(e):console.log("heavenJS just support a browser")}("undefined"!=typeof window?window:this,function(__GLOBAL){var ajaxHeader,isObject=function(e){return!Array.isArray(e)&&"object"==typeof e},isUndef=function(e){return"undefined"==typeof e},isNull=function(e){return"null"==typeof e},isArray=function(e){return Array.isArray(e)},reqAjax=function(e,t){var a=new XMLHttpRequest;a.open(e.method.toUpperCase(),e.url,"undefined"==typeof e.async||e.async),isUndef(ajaxHeader)||ajaxHeader(a),isUndef(e.requestHeader)||e.requestHeader(a),a.onreadystatechange=function(){4==this.readyState&&200==this.status&&t(this.responseText,"success"),200!==this.status&&t(this.status,"error")},"undefined"!=typeof e.send?a.send(e.send):a.send()},mObject=function(e,t){for(var a in e)t.hasOwnProperty(a)&&isObject(e[a])&&isObject(t[a])?mObject(e[a],t[a]):t[a]=e[a];return t},each=function(e,t){var a=0;for(a;a<e.length;++a)t(a,e[a])},parentAttr=function(e,t){null==e.parentNode.getAttribute("stage")?parentAttr(e.parentNode,parent):t(e.parentNode)},template=function(e,t){var a=new rExp(/::\$tpl\{([\w]+)\}/);a.raw().test(e)&&a.get(e,"g").forEach(function(e){t(a.get(e))})},rExp=function(e){return this.Exp=e,this},gForm=function(e){return this.form=e,this.setValidate={},this};rExp.prototype={raw:function(){var e=this.Exp;return new RegExp(e)},get:function(e,t){var a=this.Exp;return a=isUndef(t)?new RegExp(a):new RegExp(a,t),e.match(a)}},gForm.prototype={attr:function(e){return this.form.getAttribute(e)},tObject:function(){var e={},t={},a=function(e){var t=!1;return(e.hasAttribute("h:validate")||e.hasAttribute("h:vld"))&&(t=!0),t},r=function(e){var t;return e.hasAttribute("h:validate")?t=e.getAttribute("h:validate"):e.hasAttribute("h:vld")&&(t=e.getAttribute("h:vld")),t};return each(this.form,function(n,s){var o=function(e){return s.getAttribute(e)};switch(s.tagName.toLowerCase()){case"input":s.hasAttribute("name")&&(e[o("name")]=s.value),a(s)&&(t[o("name")]=r(s));break;case"textarea":s.hasAttribute("name")&&(e[o("name")]=s.value),a(s)&&(t[o("name")]=r(s));break;case"select":s.hasAttribute("name")&&(e[o("name")]=s.value),a(s)&&(t[o("name")]=r(s))}}),this.setValidate=t,e},getValidation:function(){return this.setValidate}},Object.defineProperty(Object.prototype,"getProp",{value:function(e){var t=null;if(isObject(this)&&"string"==typeof e)for(e=e.split(".");e.length;)t=this[e.shift()];return t},enumerable:!1});var heavenJS=function(inst){var storage={data:{},request:{},autoRender:!0,commandExclusive:!0,symbolMapper:{at:"#"},template:{}},rawTpl,asset={};!isUndef(inst)&&isObject(inst)&&(isUndef(inst.requestHeader)||(ajaxHeader=inst.requestHeader,delete inst.requestHeader),!isUndef(inst.vData)&&isObject(inst.vData)&&mObject(inst.vData,storage.data)&&delete inst.vData,storage=mObject(inst,storage));var setStorage=function(e){storage=mObject(e,storage)},setData=function(e,t){isObject(t)?storage.data[e]=mObject(t,storage.data[e]):storage.data[e]=t},setRequest=function(e,t){storage.request[e]=t},setRawTpl=function(e){rawTpl=e},getStorage=function(){return storage},getRawTpl=function(){return rawTpl},setTpl=function(e,t){storage.template[e]=t},commandExclusive=function(sel,tpl){var control=document.querySelector('[control="'+storage.control+'"]');isUndef(rawTpl)&&(rawTpl=control.innerHTML),isUndef(tpl)||(control=control.querySelector(sel));var rawHTML=isUndef(tpl)?rawTpl:tpl,exp="<!--:";exp+="[`~\\@#\\$\\%\\^\\&\\*\\(\\)\\-_=+\\{\\}\\[\\]\\|;:\"'\\<\\,\\>\\.\\?\\/\\w\\s\\|]+",exp+=":-->";var re=new rExp(exp);if(re.raw().test(rawHTML)){var expCode=new rExp(/<!--:([\w\s\D]+):-->/);re.get(rawHTML,"g").forEach(function(so){var loop="";if(expCode.raw().test(so)){var rawCode=expCode.get(so)[1],vOb=new rExp(storage.symbolMapper.at+"([\\w]+) :: ([\\w ]+)");vOb.raw().test(rawCode)&&vOb.get(rawCode,"g").forEach(function(e){e=vOb.get(e),setData(e[1],e[2])});var vRe=new rExp(storage.symbolMapper.at+"([\\w]+) :: \\[([A-Z]+)\\] ([\\-\\w\\?\\/\\@\\#\\$\\%\\&\\*:\\.\\,=]+)");vRe.raw().test(rawCode)&&vRe.get(rawCode,"g").forEach(function(e){e=vRe.get(e),setRequest(e[1],{method:e[2],url:e[3]})});var vFu=new rExp(/[~\w]+ :: [\w]+ [a-z]+ [\w]+\.\s[\?\{\}\(\)\[\]"`:+\@#\&\*\$\/\.\^\,>%<=\s\w\-\|\\]+::end\./);vFu.raw().test(rawCode)&&vFu.get(rawCode,"g").forEach(function(index){var fE=new rExp(/forEach :: ([\w]+) as ([\w]+)\.\s([\w\s\D]+)::end\./);if(fE.raw().test(index)){fE=fE.get(index);var vO,asIs=fE[2],eL=fE[3],num;isUndef(asset[fE[1]])||isUndef(asset[fE[1]].num)||(num=asset[fE[1]].num),storage.data.hasOwnProperty(fE[1])&&(template(eL,function(e){isUndef(storage.template[e[1]])||(eL=eL.replace(e[0],storage.template[e[1]]))}),vO=storage.data[fE[1]],isArray(vO)&&vO.forEach(function(v){var nEl=eL;/::[\w]+\.[\.\w]+|::[\w\(\)]+/.test(eL)&&eL.match(/::[\w]+\.[\.\w]+|::[\w]+\{[ \,\.><#\&\|"'\+\=\-\%\*\?\/\:\w\(\)]+\}|::[\w]+/g).forEach(function(vE){var vOe;if(/::[\w]+\{[ \,\.><#\&\|"'\+\=\-\%\*\?\/\:\w\(\)]+\}/.test(vE)){var vOf=vE.match(/::([\w]+)\{([ \D\w]+)\}/);if("loop"===vOf[1])isUndef(num)&&(num=parseInt(vOf[2])),vOe=num,num++;else if("js"===vOf[1]){var vOb=new rExp(/[a-zA-Z]+[\w\.]+/);vOb.raw().test(vOf[2])&&vOb.get(vOf[2],"g").forEach(function(e){var t;/[\w]+\.[\w\.]+/.test(e)?(t=e.match(/([\w]+)\.([\.\w]+)/),asIs===t[1]?t=v.getProp(t[2]):storage.data.hasOwnProperty(t[1])&&(t=storage.data[t[1]].getProp(t[2]))):(t=e.match(/([\w]+)/)[1],asIs===t?t=v:storage.data.hasOwnProperty(t)&&(t=storage.data[t])),isUndef(t)||(vOf[2]=vOf[2].replace(e,t))}),/\&not/.test(vOf[2])&&(vOf[2]=vOf[2].replace(/\&not/,"!==")),vOe=eval(vOf[2])}}else/::[\w]+\.[\.\w]+/.test(vE)?(vOe=vE.match(/::([\w]+)\.([\.\w]+)/),asIs===vOe[1]?vOe=v.getProp(vOe[2]):storage.data.hasOwnProperty(vOe[1])&&(vOe=storage.data[vOe[1]].getProp(vOe[2]))):(vOe=vE.match(/::([\w]+)/)[1],asIs===vOe?vOe=v:storage.data.hasOwnProperty(vOe)&&(vOe=storage.data[vOe]));nEl=nEl.replace(vE,vOe)}),loop+=nEl}))}});var vEl=new rExp(/[~\w]+ :: [\w]+\.\s[\&\#\?\{\}\(\)\[\]"`:+\@\*\$\/\.\^\,>%<=\s\w\-\|\\]+\s::end\./);vEl.raw().test(rawCode)&&vEl.get(rawCode,"g").forEach(function(index){var eL=new rExp(/return :: element\.\s([\w\s\D]+)::end\./);if(eL.raw().test(index)){eL=eL.get(index),template(eL[1],function(e){isUndef(storage.template[e[1]])||(eL[1]=eL[1].replace(e[0],storage.template[e[1]]))});var patt=new rExp("::([\\w]+)\\.([\\.\\w]+)|::[\\w]+\\{[ \\,\\.><#\\&\\|\"'\\+\\=\\-\\%\\*\\?\\/\\:\\w\\(\\)]+\\}|::([\\w]+)"),nEl=eL[1];patt.raw().test(eL[1])&&patt.get(eL[1],"g").forEach(function(v){var vI=new rExp(/::([\w]+)/).get(v)[1],vO;if(/::js\{[ \,\.><#\&\|"'\+\=\-\%\*\?\/\:\w\(\)]+\}/.test(v)){var vOf=v.match(/::[\w]+\{([ \D\w]+)\}/),vOb=new rExp(/[a-zA-Z]+[\w\.]+/);vOb.raw().test(vOf[1])&&vOb.get(vOf[1],"g").forEach(function(e){var t;/[\w]+\.[\w\.]+/.test(e)?(t=e.match(/([\w]+)\.([\.\w]+)/),storage.data.hasOwnProperty(t[1])&&(t=storage.data[t[1]].getProp(t[2]))):(t=e.match(/([\w]+)/)[1],storage.data.hasOwnProperty(t)&&(t=storage.data[t])),isUndef(t)||(vOf[1]=vOf[1].replace(e,t))}),/\&not/.test(vOf[1])&&(vOf[1]=vOf[1].replace(/\&not/,"!==")),vO=eval(vOf[1])}else storage.data.hasOwnProperty(vI)&&(/::[\w]+\.[\.\w]+/.test(v)?(vO=v.match(/::[\w]+\.([\.\w]+)/),vO=storage.data[vI].getProp(vO[1])):vO=storage.data[vI]);nEl=nEl.replace(v,vO)}),loop+=nEl}}),rawHTML=rawHTML.replace(so,loop),control.innerHTML=rawHTML}})}};this.setStorage=setStorage,this.setData=setData,this.setRawTpl=setRawTpl,this.getStorage=getStorage,this.getRawTpl=getRawTpl,this.commandExclusive=commandExclusive,this.setTpl=setTpl,this.asset=function(e,t){asset[e]=t},storage.autoRender&&!isUndef(storage.control)&&"string"==typeof storage.control&&storage.commandExclusive&&commandExclusive()};heavenJS.prototype.control=function(e){return"string"==typeof e&&this.setStorage({control:e}),this},heavenJS.prototype.data=function(e,t){"string"==typeof e&&this.setData(e,t)},heavenJS.prototype.tpl=function(e,t){this.setTpl(e,t)},heavenJS.prototype.request=function(e,t){var a=this,r=new rExp(/^([\w]+) applyTo ([\w]+)$|^([\w]+)$/),n=this.getStorage(),s=this.render,o=this.setData;if(r.raw().test(e)){var i=/^([\w]+) applyTo ([\w]+)$/.test(e)?e.match(/^([\w]+) applyTo ([\w]+)$/):e.match(/^([\w]+)$/);isUndef(n.request[i[1]])||reqAjax(n.request[i[1]],function(r,n){if("success"==n){var f=function(e){"string"==typeof e&&(/^render\([\w\W]+\)/.test(e)?(e=e.match(/^render\(([\w\W]+)\)/)[1],s(e,a)):/^[\w]+/.test(e)&&s('[stage="'+e+'"',a))},c="object"==typeof r?r:JSON.parse(r);/^([\w]+) applyTo ([\w]+)$/.test(e)?isUndef(t)||"function"!=typeof t?(o(i[2],c),f(t)):t({nData:function(e){isObject(e)?o(i[2],mObject(e,c)):o(i[2],e)},eRender:function(e){var t={};if(isUndef(this.nData)){for(var a in this)"eRender"===a&&a===t||(t[a]=this[a]);o(i[2],mObject(t,c))}f(e)}},c):t(c)}})}},heavenJS.prototype.form=function(e,t){document.querySelector("body").onsubmit=function(a){if(a.target.getAttribute("h:submit")===e){a.preventDefault(),tForm=a.target;var r=new gForm(tForm.querySelectorAll("[name]")),n=r.tObject(),s={},o=r.getValidation();if(!isUndef(t)&&isObject(t)){if(t.autoSend=!0,t.notValid=!1,t.validation=function(e){o=mObject(e,o)},isUndef(t.before())||t.before({add:function(){for(var e in this)"function"!=typeof this[e]&&(n[e]=this[e])}}),0!==Object.getOwnPropertyNames(o).length)for(var i in o)if(n.hasOwnProperty(i))if("function"==typeof o[i]);else{var f=o[i].split("|");each(f,function(e,t){if("required"===t){var a={code:1,message:"field required"};0===n[i].length&&(s.hasOwnProperty(i)?s[i].push(a):s[i]=[a])}if(/^min:[0-9]+$/.test(t)){var r=t.match(/^min:([0-9]+)$/)[1],a={code:2,message:"field length less than "+r};n[i].length<r&&(s.hasOwnProperty(i)?s[i].push(a):s[i]=[a])}if(/^max:[0-9]+$/.test(t)){var o=t.match(/^max:([0-9]+)$/)[1],a={code:3,message:"field length more than "+o};n[i].length>o&&(s.hasOwnProperty(i)?s[i].push(a):s[i]=[a])}if(/^eq:[\w]+$/.test(t)){var f=t.match(/^eq:([\w]+)$/)[1],a={code:4,message:i+" not match with "+f};n[i]!==n[f]&&(s.hasOwnProperty(i)?s[i].push(a):s[i]=[a])}if("email"===t&&!/^[_\.\w]+\@[_\.\w]+/.test(n[i])){var a={code:5,message:"email field incorrect"};s.hasOwnProperty(i)?s[i].push(a):s[i]=[a]}if(/^\[[-+\w]+\]$/.test(t)){var c=new rExp(t+"+"),a={code:6,message:"field is incorrect"};c.raw().test(n[i])||(s.hasOwnProperty(i)?s[i].push(a):s[i]=[a])}})}if(0!==Object.getOwnPropertyNames(s).length)t.notValid=!0,t.validateError=s;else if(t.autoSend){var c=new gForm(tForm),v={url:c.attr("action"),method:c.attr("method"),send:JSON.stringify(n),requestHeader:function(e){e.setRequestHeader("Content-Type","application/json;charset=UTF-8")}};reqAjax(v,function(e,a){!isUndef(t.onReceive)&&t.onReceive(e,a)})}!isUndef(t.readyState)&&t.readyState()}}}},heavenJS.prototype.render=function(e,t){var a=new DOMParser,r=isUndef(t)?this:t,n=isUndef(r.getRawTpl())?document.querySelector('[control="'+r.getStorage().control+'"]'):r.getRawTpl(),s=a.parseFromString(n,"text/html"),o=s.querySelector(e);isUndef(e)?r.commandExclusive():r.commandExclusive(e,o.innerHTML)},__GLOBAL.heavenJS=heavenJS});
